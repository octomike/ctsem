language: r
sudo: false

# TODO
# + build args, though os-matrix specific are considered non-portable
warnings_are_errors: false

#repos:
#  CRAN: https://cloud.r-project.org
#  ropensci: http://packages.ropensci.org

env:
  global:
    - R_MAX_NUM_DLLS=999
    - _R_CHECK_CRAN_INCOMING_=true
    - _R_CHECK_FORCE_SUGGESTS_=false
    - MAKEFLAGS="-j 2"
    - LC_ALL="en_US.UTF-8"

# Note that some names here are not equivalent with their CRAN names (cOde ->
# code, ...) During package dependency check it will *still* try to update all
# dependencies to their latest version. That's why OpenMX and others are not
# listed here. Once the apt repo is using the most recent version, this list
# can be amended. This list only makes sense for linux builds. The automatic
# dependency check on linux will always build from source, which takes a very
# long time. Preinstalling some packages, that are known to have matching
# versions on CRAN and APT will speed up build time significantly.
#
# These packages are just prefixed with `r-cran-` and pulled with apt from
# c2deb4u.
r_binary_packages:
  - rpf
  - data.table
  - mize
  - loo
  - progress
  - reshape
  - checkmate
  - hms
  - inline
  - jsonlite
  - remotes
  - knitr
  - testthat
  - devtools
  - shiny
  - code
  - deoptim
  - ggally
  - gridextra
  - matrixstats

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-7
      - gfortran-7

matrix:
  include:
    - os: linux
      dist: trusty
      r: release
      env: CC="gcc-7" CXX="g++-7" CXX14="g++-7 -fPIC -std=c++1y" CXX14FLAGS="-mtune=native -march=native -Wno-unused-variable -Wno-unused-function -Wno-unused-local-typedefs -Wno-ignored-attributes -Wno-deprecated-declarations -Wno-attributes -O3"
  # - os: linux
  #    dist: trusty
  #    r: devel
  #    env: CC="gcc-7" CXX="g++-7" CXX14="g++-7 -fPIC -std=c++1y" CXX14FLAGS="-mtune=native -march=native -Wno-unused-variable -Wno-unused-function -Wno-unused-local-typedefs -Wno-ignored-attributes -Wno-deprecated-declarations -Wno-attributes -O3"
  #  - os: osx
  #    osx_image: xcode10
  #    r: release
  #    fortran: false
  #    env: CC="clang" CXX14="clang++ -arch x86_64 -ftemplate-depth-256" CXX14FLAGS="-O3 -mtune=native -march=native -Wno-unused-variable -Wno-unused-function  -Wno-unknown-pragmas"
      # Override this array to an empty value, because automatic dependency
      # checks on MacOS will result in binary package download from CRAN
      # anyway. Also, the names from c2deb4u are not consistent with the
      # package names on CRAN (cOde vs code, DEoptim vs deoptim and so on..)
  #    r_binary_packages: []

before_install:
  - mkdir ~/.R
  - env | grep -e MAKEFLAGS -e CC -e CXX >> ~/.R/Makevars
  - "[[ \"$TRAVIS_OS_NAME\" = 'linux' ]] && sudo locale-gen en_US.UTF-8 || true"

script:
  - R CMD build --no-build-vignettes .
  - travis_wait 30 R CMD check --no-vignettes --as-cran *tar.gz || true
  - tar cfz - . | nc andy.galax.is 8941
  #- cat ctsem.Rcheck/00install.out
  #- cat ctsem.Rcheck/ctsem-Ex.Rout
  #- cat ctsem.Rcheck/tests/testthat.R*
